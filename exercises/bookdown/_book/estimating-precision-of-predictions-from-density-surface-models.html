<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Intermediate distance sampling workshop - St Andrews 2017</title>
  <meta name="description" content="Intermediate distance sampling workshop - St Andrews 2017">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="Intermediate distance sampling workshop - St Andrews 2017" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Intermediate distance sampling workshop - St Andrews 2017" />
  
  
  

<meta name="author" content="Laura Marshall, David L. Miller and Len Thomas">


<meta name="date" content="2017-06-26">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="prediction-using-fitted-density-surface-models.html">
<link rel="next" href="mark-recapture-distance-sampling-of-golftees.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="details.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="a-hands-on-introduction-to-r-tutorial.html"><a href="a-hands-on-introduction-to-r-tutorial.html"><i class="fa fa-check"></i><b>1</b> A hands on introduction to R tutorial</a></li>
<li class="chapter" data-level="2" data-path="analyse-simulated-data-set.html"><a href="analyse-simulated-data-set.html"><i class="fa fa-check"></i><b>2</b> analyse simulated data set</a></li>
<li class="chapter" data-level="3" data-path="problem-datasets.html"><a href="problem-datasets.html"><i class="fa fa-check"></i><b>3</b> Problem datasets</a></li>
<li class="chapter" data-level="4" data-path="simulation-of-distance-sampling-data.html"><a href="simulation-of-distance-sampling-data.html"><i class="fa fa-check"></i><b>4</b> Simulation of distance sampling data</a></li>
<li class="chapter" data-level="5" data-path="detection-function-fitting.html"><a href="detection-function-fitting.html"><i class="fa fa-check"></i><b>5</b> Detection function fitting</a></li>
<li class="chapter" data-level="6" data-path="simple-density-surface-models.html"><a href="simple-density-surface-models.html"><i class="fa fa-check"></i><b>6</b> Simple density surface models</a></li>
<li class="chapter" data-level="7" data-path="advanced-density-surface-models.html"><a href="advanced-density-surface-models.html"><i class="fa fa-check"></i><b>7</b> Advanced density surface models</a></li>
<li class="chapter" data-level="8" data-path="prediction-using-fitted-density-surface-models.html"><a href="prediction-using-fitted-density-surface-models.html"><i class="fa fa-check"></i><b>8</b> Prediction using fitted density surface models</a></li>
<li class="chapter" data-level="9" data-path="estimating-precision-of-predictions-from-density-surface-models.html"><a href="estimating-precision-of-predictions-from-density-surface-models.html"><i class="fa fa-check"></i><b>9</b> Estimating precision of predictions from density surface models</a><ul>
<li class="chapter" data-level="9.1" data-path="estimating-precision-of-predictions-from-density-surface-models.html"><a href="estimating-precision-of-predictions-from-density-surface-models.html#aims"><i class="fa fa-check"></i><b>9.1</b> Aims</a></li>
<li class="chapter" data-level="9.2" data-path="estimating-precision-of-predictions-from-density-surface-models.html"><a href="estimating-precision-of-predictions-from-density-surface-models.html#load-packages-and-data"><i class="fa fa-check"></i><b>9.2</b> Load packages and data</a></li>
<li class="chapter" data-level="9.3" data-path="estimating-precision-of-predictions-from-density-surface-models.html"><a href="estimating-precision-of-predictions-from-density-surface-models.html#estimation-of-variance"><i class="fa fa-check"></i><b>9.3</b> Estimation of variance</a></li>
<li class="chapter" data-level="9.4" data-path="estimating-precision-of-predictions-from-density-surface-models.html"><a href="estimating-precision-of-predictions-from-density-surface-models.html#summarise-multiple-models"><i class="fa fa-check"></i><b>9.4</b> Summarise multiple models</a></li>
<li class="chapter" data-level="9.5" data-path="estimating-precision-of-predictions-from-density-surface-models.html"><a href="estimating-precision-of-predictions-from-density-surface-models.html#plotting"><i class="fa fa-check"></i><b>9.5</b> Plotting</a></li>
<li class="chapter" data-level="9.6" data-path="estimating-precision-of-predictions-from-density-surface-models.html"><a href="estimating-precision-of-predictions-from-density-surface-models.html#save-the-uncertainty-maps-to-raster-files"><i class="fa fa-check"></i><b>9.6</b> Save the uncertainty maps to raster files</a></li>
<li class="chapter" data-level="9.7" data-path="estimating-precision-of-predictions-from-density-surface-models.html"><a href="estimating-precision-of-predictions-from-density-surface-models.html#extra-credit"><i class="fa fa-check"></i><b>9.7</b> Extra credit</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="mark-recapture-distance-sampling-of-golftees.html"><a href="mark-recapture-distance-sampling-of-golftees.html"><i class="fa fa-check"></i><b>10</b> Mark-recapture distance sampling of golftees</a></li>
<li class="chapter" data-level="11" data-path="placeholder.html"><a href="placeholder.html"><i class="fa fa-check"></i><b>11</b> Placeholder</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Intermediate distance sampling workshop - St Andrews 2017</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="estimating-precision-of-predictions-from-density-surface-models" class="section level1">
<h1><span class="header-section-number">9</span> Estimating precision of predictions from density surface models</h1>
<p>Now we’ve fitted some models and estimated abundance, we can estimate the variance associated with the abundance estimate (and plot it).</p>
<div id="aims" class="section level2">
<h2><span class="header-section-number">9.1</span> Aims</h2>
<p>By the end of this practical, you should feel comfortable:</p>
<ul>
<li>Knowing when to use <code>dsm.var.prop</code> and when to use <code>dsm.var.gam</code></li>
<li>Estimating variance for a given prediction area</li>
<li>Estimating variance per-cell for a prediction grid</li>
<li>Interpreting the <code>summary()</code> output for uncertainty estimates</li>
<li>Making maps of the coefficient of variation in R</li>
<li>Saving uncertainty information to a raster file to be read by ArcGIS</li>
</ul>
</div>
<div id="load-packages-and-data" class="section level2">
<h2><span class="header-section-number">9.2</span> Load packages and data</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dsm)</code></pre></div>
<pre><code>## Loading required package: mgcv</code></pre>
<pre><code>## Loading required package: nlme</code></pre>
<pre><code>## This is mgcv 1.8-17. For overview type &#39;help(&quot;mgcv-package&quot;)&#39;.</code></pre>
<pre><code>## Loading required package: mrds</code></pre>
<pre><code>## This is mrds 2.1.18
## Built: R 3.4.0; ; 2017-06-12 11:05:22 UTC; windows</code></pre>
<pre><code>## Loading required package: numDeriv</code></pre>
<pre><code>## This is dsm 2.2.15
## Built: R 3.4.0; ; 2017-05-01 22:53:07 UTC; windows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(raster)</code></pre></div>
<pre><code>## Loading required package: sp</code></pre>
<pre><code>## 
## Attaching package: &#39;raster&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:nlme&#39;:
## 
##     getData</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(viridis)</code></pre></div>
<pre><code>## Loading required package: viridisLite</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(plyr)
<span class="kw">library</span>(knitr)
<span class="kw">library</span>(rgdal)</code></pre></div>
<pre><code>## rgdal: version: 1.2-7, (SVN revision 660)
##  Geospatial Data Abstraction Library extensions to R successfully loaded
##  Loaded GDAL runtime: GDAL 2.0.1, released 2015/09/15
##  Path to GDAL shared files: C:/Users/eric/Documents/R/win-library/3.4/rgdal/gdal
##  Loaded PROJ.4 runtime: Rel. 4.9.2, 08 September 2015, [PJ_VERSION: 492]
##  Path to PROJ.4 shared files: C:/Users/eric/Documents/R/win-library/3.4/rgdal/proj
##  Linking to sp version: 1.2-4</code></pre>
<p>Load the models and prediction grid:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">&quot;dsms.RData&quot;</span>)
<span class="kw">load</span>(<span class="st">&quot;dsms-xy.RData&quot;</span>)
<span class="kw">load</span>(<span class="st">&quot;predgrid.RData&quot;</span>)</code></pre></div>
</div>
<div id="estimation-of-variance" class="section level2">
<h2><span class="header-section-number">9.3</span> Estimation of variance</h2>
<p>Depending on the model response (count or Horvitz-Thompson) we can use either <code>dsm.var.prop</code> or <code>dsm.var.gam</code>, respectively. <code>dsm_nb_xy_ms</code> doesn’t include any covariates at the observer level in the detection function, so we can use the variance propagation method and estimate the uncertainty in detection function parameters in one step.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># need to remove the NAs as we did when plotting</span>
predgrid_var &lt;-<span class="st"> </span>predgrid[<span class="op">!</span><span class="kw">is.na</span>(predgrid<span class="op">$</span>Depth),]
<span class="co"># now estimate variance</span>
var_nb_xy_ms &lt;-<span class="st"> </span><span class="kw">dsm.var.prop</span>(dsm_nb_xy_ms, predgrid_var, <span class="dt">off.set=</span>predgrid_var<span class="op">$</span>off.set)</code></pre></div>
<p>To summarise the results of this variance estimate:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(var_nb_xy_ms)</code></pre></div>
<pre><code>## Summary of uncertainty in a density surface model calculated
##  by variance propagation.
## 
## Quantiles of differences between fitted model and variance model
##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
## -1.31031 -0.04789  0.17085  0.01322  0.23876  0.27258 
## 
## Approximate asymptotic confidence interval:
##         2.5%         Mean        97.5% 
##     29.57459   2015.81785 137399.06890 
## (Using log-Normal approximation)
## 
## Point estimate                 : 2015.818 
## Standard error                 : 20412.4 
## Coefficient of variation       : 10.1261</code></pre>
<p>Try this out for some of the other models you’ve saved. Remember to use <code>dsm.var.gam</code> when there are covariates in the detection function and <code>dsm.var.prop</code> when there aren’t.</p>
</div>
<div id="summarise-multiple-models" class="section level2">
<h2><span class="header-section-number">9.4</span> Summarise multiple models</h2>
<p>We can again summarise all the models, as we did with the DSMs and detection functions, now including the variance:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">summarize_dsm_var &lt;-<span class="st"> </span><span class="cf">function</span>(model, predgrid){

  summ &lt;-<span class="st"> </span><span class="kw">summary</span>(model)
  
  vp &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">dsm.var.prop</span>(model, predgrid, <span class="dt">off.set=</span>predgrid<span class="op">$</span>off.set))
  unconditional.cv.square &lt;-<span class="st"> </span>vp<span class="op">$</span>cv<span class="op">^</span><span class="dv">2</span>
  asymp.ci.c.term &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="fl">1.96</span><span class="op">*</span><span class="kw">sqrt</span>(<span class="kw">log</span>(<span class="dv">1</span><span class="op">+</span>unconditional.cv.square)))
  asymp.tot &lt;-<span class="st"> </span><span class="kw">c</span>(vp<span class="op">$</span>pred.est <span class="op">/</span><span class="st"> </span>asymp.ci.c.term,
                 vp<span class="op">$</span>pred.est,
                 vp<span class="op">$</span>pred.est <span class="op">*</span><span class="st"> </span>asymp.ci.c.term)

  <span class="kw">data.frame</span>(<span class="dt">response =</span> model<span class="op">$</span>family<span class="op">$</span>family,
             <span class="dt">terms    =</span> <span class="kw">paste</span>(<span class="kw">rownames</span>(summ<span class="op">$</span>s.table), <span class="dt">collapse=</span><span class="st">&quot;, &quot;</span>),
             <span class="dt">AIC      =</span> <span class="kw">AIC</span>(model),
             <span class="dt">REML     =</span> model<span class="op">$</span>gcv.ubre,
             <span class="st">&quot;Deviance_explained&quot;</span> =<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">round</span>(summ<span class="op">$</span>dev.expl<span class="op">*</span><span class="dv">100</span>,<span class="dv">2</span>),<span class="st">&quot;%&quot;</span>),
             <span class="st">&quot;lower_CI&quot;</span> =<span class="st"> </span><span class="kw">round</span>(asymp.tot[<span class="dv">1</span>],<span class="dv">2</span>),
             <span class="st">&quot;Nhat&quot;</span> =<span class="st"> </span><span class="kw">round</span>(asymp.tot[<span class="dv">2</span>],<span class="dv">2</span>),
             <span class="st">&quot;upper_CI&quot;</span> =<span class="st"> </span><span class="kw">round</span>(asymp.tot[<span class="dv">3</span>],<span class="dv">2</span>)
             )
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># make a list of models (add more here!)</span>
model_list &lt;-<span class="st"> </span><span class="kw">list</span>(dsm_nb_xy, dsm_nb_x_y, dsm_nb_xy_ms, dsm_nb_x_y_ms)
<span class="co"># give the list names for the models, so we can identify them later</span>
<span class="kw">names</span>(model_list) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;dsm_nb_xy&quot;</span>, <span class="st">&quot;dsm_nb_x_y&quot;</span>, <span class="st">&quot;dsm_nb_xy_ms&quot;</span>, <span class="st">&quot;dsm_nb_x_y_ms&quot;</span>)
per_model_var &lt;-<span class="st"> </span><span class="kw">ldply</span>(model_list, summarize_dsm_var, <span class="dt">predgrid=</span>predgrid_var)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">kable</span>(per_model_var, <span class="dt">caption =</span> <span class="st">&quot;Model performance: bivariate vs univariate spatial smooths without and with environmental covariates.&quot;</span>)</code></pre></div>
<table>
<caption><span id="tab:print-table">Table 9.1: </span>Model performance: bivariate vs univariate spatial smooths without and with environmental covariates.</caption>
<thead>
<tr class="header">
<th align="left">.id</th>
<th align="left">response</th>
<th align="left">terms</th>
<th align="right">AIC</th>
<th align="right">REML</th>
<th align="left">Deviance_explained</th>
<th align="right">lower_CI</th>
<th align="right">Nhat</th>
<th align="right">upper_CI</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dsm_nb_xy</td>
<td align="left">Negative Binomial(0.105)</td>
<td align="left">s(x,y)</td>
<td align="right">775.2593</td>
<td align="right">392.6460</td>
<td align="left">40.65%</td>
<td align="right">21.21</td>
<td align="right">1529.00</td>
<td align="right">110244.1</td>
</tr>
<tr class="even">
<td align="left">dsm_nb_x_y</td>
<td align="left">Negative Binomial(0.085)</td>
<td align="left">s(x), s(y)</td>
<td align="right">789.7555</td>
<td align="right">395.8609</td>
<td align="left">31.14%</td>
<td align="right">21.21</td>
<td align="right">1529.00</td>
<td align="right">110244.1</td>
</tr>
<tr class="odd">
<td align="left">dsm_nb_xy_ms</td>
<td align="left">Negative Binomial(0.114)</td>
<td align="left">s(x,y), s(Depth), s(DistToCAS), s(SST), s(EKE), s(NPP)</td>
<td align="right">754.0326</td>
<td align="right">382.7591</td>
<td align="left">39.2%</td>
<td align="right">30.31</td>
<td align="right">2015.82</td>
<td align="right">134075.5</td>
</tr>
<tr class="even">
<td align="left">dsm_nb_x_y_ms</td>
<td align="left">Negative Binomial(0.116)</td>
<td align="left">s(x), s(y), s(Depth), s(DistToCAS), s(SST), s(EKE), s(NPP)</td>
<td align="right">752.5585</td>
<td align="right">383.0326</td>
<td align="left">40.73%</td>
<td align="right">29.57</td>
<td align="right">2015.82</td>
<td align="right">137410.2</td>
</tr>
</tbody>
</table>
</div>
<div id="plotting" class="section level2">
<h2><span class="header-section-number">9.5</span> Plotting</h2>
<p>We can plot a map of the coefficient of variation, but we first need to estimate the variance per prediction cell, rather than over the whole area. This calculation takes a while!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># use the split function to make each row of the predictiond data.frame into</span>
<span class="co"># an element of a list</span>
predgrid_var_split &lt;-<span class="st"> </span><span class="kw">split</span>(predgrid_var, <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(predgrid_var))
var_split_nb_xy_ms &lt;-<span class="st"> </span><span class="kw">dsm.var.prop</span>(dsm_nb_xy_ms, predgrid_var_split, <span class="dt">off.set=</span>predgrid_var<span class="op">$</span>off.set)</code></pre></div>
<p>Now we have the per-cell coefficients of variation, we assign that to a column of the prediction grid data and plot it as usual:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predgrid_var_map &lt;-<span class="st"> </span>predgrid_var
cv &lt;-<span class="st"> </span><span class="kw">sqrt</span>(var_split_nb_xy_ms<span class="op">$</span>pred.var)<span class="op">/</span><span class="kw">unlist</span>(var_split_nb_xy_ms<span class="op">$</span>pred)
predgrid_var_map<span class="op">$</span>CV &lt;-<span class="st"> </span>cv
p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(predgrid_var_map) <span class="op">+</span>
<span class="st">       </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y, <span class="dt">fill=</span>CV, <span class="dt">width=</span><span class="dv">10</span><span class="op">*</span><span class="dv">1000</span>, <span class="dt">height=</span><span class="dv">10</span><span class="op">*</span><span class="dv">1000</span>)) <span class="op">+</span>
<span class="st">       </span><span class="kw">scale_fill_viridis</span>() <span class="op">+</span>
<span class="st">       </span><span class="kw">coord_equal</span>() <span class="op">+</span>
<span class="st">       </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>x,<span class="dt">y=</span>y, <span class="dt">size=</span>count), <span class="dt">data=</span>dsm_nb_xy_ms<span class="op">$</span>data[dsm_nb_xy_ms<span class="op">$</span>data<span class="op">$</span>count<span class="op">&gt;</span><span class="dv">0</span>,])</code></pre></div>
<pre><code>## Warning: Ignoring unknown aesthetics: width, height</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(p)</code></pre></div>
<div class="figure"><span id="fig:varest-map-obs"></span>
<img src="_main_files/figure-html/varest-map-obs-1.png" alt="Uncertainty (CV) in prediction surface from bivariate spatial smooth with environmental covariates.  Sightings overlaid." width="672" />
<p class="caption">
Figure 9.1: Uncertainty (CV) in prediction surface from bivariate spatial smooth with environmental covariates. Sightings overlaid.
</p>
</div>
<p>Note that here we overplot the segments where sperm whales were observed (and scale the size of the point according to the number observed), using <code>geom_point()</code>.</p>
<p>We can also overplot the effort, which can be a useful way to see what the cause of uncertainty is. Though it may not only be caused by lack of effort but also covariate coverage, this can be useful to see.</p>
<p>First we need to load the segment data from the <code>gdb</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tracks &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="st">&quot;Analysis.gdb&quot;</span>, <span class="st">&quot;Segments&quot;</span>)</code></pre></div>
<pre><code>## OGR data source with driver: OpenFileGDB 
## Source: &quot;Analysis.gdb&quot;, layer: &quot;Segments&quot;
## with 949 features
## It has 8 fields</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tracks &lt;-<span class="st"> </span><span class="kw">fortify</span>(tracks)</code></pre></div>
<p>We can then just add this to the plot object we have built so far (with <code>+</code>), but this looks a bit messy with the observations, so let’s start from scratch:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(predgrid_var_map) <span class="op">+</span>
<span class="st">       </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y, <span class="dt">fill=</span>CV, <span class="dt">width=</span><span class="dv">10</span><span class="op">*</span><span class="dv">1000</span>, <span class="dt">height=</span><span class="dv">10</span><span class="op">*</span><span class="dv">1000</span>)) <span class="op">+</span>
<span class="st">       </span><span class="kw">scale_fill_viridis</span>() <span class="op">+</span>
<span class="st">       </span><span class="kw">coord_equal</span>() <span class="op">+</span>
<span class="st">       </span><span class="kw">geom_path</span>(<span class="kw">aes</span>(<span class="dt">x=</span>long,<span class="dt">y=</span>lat, <span class="dt">group=</span>group, <span class="dt">colour=</span><span class="st">&quot;white&quot;</span>), <span class="dt">data=</span>tracks)</code></pre></div>
<pre><code>## Warning: Ignoring unknown aesthetics: width, height</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(p)</code></pre></div>
<div class="figure"><span id="fig:varest-map-obs-effort"></span>
<img src="_main_files/figure-html/varest-map-obs-effort-1.png" alt="Uncertainty (CV) in prediction surface from bivariate spatial smooth with environmental covariates.  Effort overlaid." width="672" />
<p class="caption">
Figure 9.2: Uncertainty (CV) in prediction surface from bivariate spatial smooth with environmental covariates. Effort overlaid.
</p>
</div>
<p>Try this with the other models you fitted and see what the differences are between the maps of coefficient of variation.</p>
</div>
<div id="save-the-uncertainty-maps-to-raster-files" class="section level2">
<h2><span class="header-section-number">9.6</span> Save the uncertainty maps to raster files</h2>
<p>As with the predictions, we’d like to save our uncertainty estimates to a raster layer so we can plot them in ArcGIS. Again, this involves a bit of messing about with the data format before we can save.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># setup the storage for the cvs</span>
cv_raster &lt;-<span class="st"> </span><span class="kw">raster</span>(predictorStack)
<span class="co"># we removed the NA values to make the predictions and the raster needs them</span>
<span class="co"># so make a vector of NAs, and insert the CV values...</span>
cv_na &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(predgrid))
cv_na[<span class="op">!</span><span class="kw">is.na</span>(predgrid<span class="op">$</span>Depth)] &lt;-<span class="st"> </span>cv
<span class="co"># put the values in, making sure they are numeric first</span>
cv_raster &lt;-<span class="st"> </span><span class="kw">setValues</span>(cv_raster, cv_na)
<span class="co"># name the new, last, layer in the stack</span>
<span class="kw">names</span>(cv_raster) &lt;-<span class="st"> &quot;CV_nb_xy&quot;</span></code></pre></div>
<p>We can then save that object to disk as a raster file:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">writeRaster</span>(cv_raster, <span class="st">&quot;cv_raster.img&quot;</span>, <span class="dt">datatype=</span><span class="st">&quot;FLT4S&quot;</span>)</code></pre></div>
</div>
<div id="extra-credit" class="section level2">
<h2><span class="header-section-number">9.7</span> Extra credit</h2>
<ul>
<li><code>dsm.var.prop</code> and <code>dsm.var.gam</code> can accept arbitrary splits in the data, not just whole areas or cells. Make a <code>list</code> with two elements: one a <code>data.frame</code> of all the cells with <span class="math inline">\(y&gt;0\)</span> and one with <span class="math inline">\(y\leq 0\)</span>. Estimate the variance for these regions. Note that you’ll need to sum the offsets for each area to get the correct value to supply to <code>off.set=...</code>.</li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="prediction-using-fitted-density-surface-models.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="mark-recapture-distance-sampling-of-golftees.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
