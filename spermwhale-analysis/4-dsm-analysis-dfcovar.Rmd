---
title: Density surface models
author: David L Miller

---

# Load some data and packages

```{r load-data-packages}
library(Distance)
library(dsm)
library(ggplot2)
library(knitr)
load("sperm-data.RData")
load("df-models.RData")
```

# Fit some models

As with the previous set of models, we fit models when `x` and `y` are included as additive terms and as a bivariate smooth and compare the resulting models.

## Quasi-Poisson

Letting `k`s go to default leaves bad "p" values (in `gam.check`) for location, disttocas, EKE, SST: set to 30/20.

```{r fit-models-qp-xy}
k2 <- 50
k1 <- 10

dsm.qp.xy <- dsm(abundance.est~s(x,y, k=k2, bs="ts")+
                                s(Depth, k=k1, bs="ts")+
#                                s(DistToCAS, k=k1, bs="ts")+
                                s(SST, k=30, bs="ts"),#+
#                                s(EKE, k=k1, bs="ts")+
#                                s(NPP, k=k1, bs="ts"),
               family=quasipoisson(),
               df_hr_ss, segs, obs, method="REML")
summary(dsm.qp.xy)
```

Checking plots look as bad as usual.

```{r qp-check-xy, fig.width=6, fig.height=6}
gam.check(dsm.qp.xy)
```


Plot the resulting smooths:

```{r qp-terms-xy, fig.width=6, fig.height=6}
plot(dsm.qp.xy, scale=0, pages=1)
```

Now fitting the additive location terms:

```{r fit-models-qp}
dsm.qp <- dsm(abundance.est~s(x, k=k1, bs="ts")+
                                s(y, k=k1, bs="ts")+
                                s(Depth, k=k1, bs="ts")+
#                                s(DistToCAS, k=k1, bs="ts")+
                                s(SST, k=30, bs="ts"),#+
#                                s(EKE, k=k1, bs="ts")+
#                                s(NPP, k=k1, bs="ts"),
               family=quasipoisson(),
               df_hr_ss, segs, obs, method="REML")
summary(dsm.qp)
```

Check plots

```{r qp-check, fig.width=6, fig.height=6}
gam.check(dsm.qp)
```


Smooths:

```{r qp-terms, fig.width=6, fig.height=6}
plot(dsm.qp, scale=0, pages=1)
```



## Tweedie


```{r fit-models-tw-xy}
dsm.tw.xy <- dsm(abundance.est~s(x,y, k=k2, bs="ts")+
                                s(Depth, k=k1, bs="ts"),#+
#                                s(DistToCAS, k=k1, bs="ts")+
#                                s(SST, k=k1, bs="ts")+
#                                s(EKE, k=k1, bs="ts"),#+
#                                s(NPP, k=k1, bs="ts"),
               family=tw(),
               df_hr_ss, segs, obs, method="REML")
summary(dsm.tw.xy)
```

```{r tw-check, fig.width=6, fig.height=6}
gam.check(dsm.tw.xy)
```

```{r tw-terms, fig.width=8}
plot(dsm.tw.xy, scale=0, pages=1)
```


```{r fit-models-tw}
dsm.tw <- dsm(abundance.est~s(x, k=k1, bs="ts")+
                                s(y, k=k1, bs="ts")+
                                s(Depth, k=k1, bs="ts"),#+
#                                s(DistToCAS, k=k1, bs="ts")+
#                                s(SST, k=k1, bs="ts")+
#                                s(EKE, k=k1, bs="ts"),#+
#                                s(NPP, k=k1, bs="ts"),
               family=tw(),
               df_hr_ss, segs, obs, method="REML")
summary(dsm.tw)
```

```{r tw-check-xy, fig.width=6, fig.height=6}
gam.check(dsm.tw)
```

```{r tw-terms-xy, fig.width=6, fig.height=6}
plot(dsm.tw, scale=0, pages=1)
```


## Negative binomial

Here note that `DistToCAS` and `EKE` are "`.`" significant AND have low EDFs.

```{r fit-models-nb-xy}
dsm.nb.xy <- dsm(abundance.est~s(x,y, k=k2, bs="ts")+
                                   s(Depth, k=k1, bs="ts"),#+
#                                   s(DistToCAS, k=k1, bs="ts")+
#                                   s(SST, k=k1, bs="ts")+
#                                   s(EKE, k=k1, bs="ts"),#+
#                                   s(NPP, k=k1, bs="ts"),
               family=nb(),
               df_hr_ss, segs, obs, method="REML")
summary(dsm.nb.xy)
```

```{r nb-check-xy, fig.width=6, fig.height=6}
gam.check(dsm.nb.xy)
```

```{r nb-terms-xy, fig.width=8}
plot(dsm.nb.xy, scale=0, pages=1)
```


```{r fit-models-nb}
dsm.nb <- dsm(abundance.est~#s(x, k=k1, bs="ts")+
                                s(y, k=k1, bs="ts")+
                                s(Depth, k=k1, bs="ts"),#+
#                                s(DistToCAS, k=k1, bs="ts")+
#                                s(SST, k=k1, bs="ts")+
#                                s(EKE, k=k1, bs="ts"),#+
#                                s(NPP, k=k1, bs="ts"),
               family=nb(),
               df_hr_ss, segs, obs, method="REML")
summary(dsm.nb)
```

```{r nb-check, fig.width=6, fig.height=6}
gam.check(dsm.nb)
```

```{r nb-terms, fig.width=8}
plot(dsm.nb, scale=0, pages=1)
```


## Model summary


```{r summarize-models}
summarize_dsm <- function(model){

  summ <- summary(model)

  data.frame(response = model$family$family,
             terms    = paste(rownames(summ$s.table), collapse=", "),
             AIC      = AIC(model),
             REML     = model$gcv.ubre,
             "Deviance explained" = paste0(round(summ$dev.expl*100,2),"%")
            )

}
library(plyr)
summary_table <- ldply(list(dsm.qp,
                             dsm.qp.xy,
                             dsm.tw,
                             dsm.tw.xy,
                             dsm.nb,
                             dsm.nb.xy),
                        summarize_dsm)
summary_table <- as.data.frame(summary_table)
row.names(summary_table) <- c("`dsm.qp`",
                              "`dsm.qp.xy`",
                              "`dsm.tw`",
                              "`dsm.tw.xy`",
                              "`dsm.nb`",
                              "`dsm.nb.xy`")
```

```{r print-table, results="asis"}
summary_table <- summary_table[order(summary_table$REML, decreasing=TRUE),]
kable(summary_table)
```

## Final models

```{r plot-qq}
par(mfrow=c(2,3))
qq.gam.p <- function(x){qq.gam(x, main=paste0(substitute(x)))}
qq.gam.p(dsm.qp)
qq.gam.p(dsm.qp.xy)
qq.gam.p(dsm.tw)
qq.gam.p(dsm.tw.xy)
qq.gam.p(dsm.nb)
qq.gam.p(dsm.nb.xy)
```


Comparing the depth terms we again see a similar story:

```{r depth-plots, fig.width=5, fig.height=8}
par(mfrow=c(3,2))
plot_depth <- function(model){
  plot(model, select=which(grepl("Depth", unlist(strsplit(as.character(terms(model$formula)[[3]]), "\\+"))))-1, scale=0, main=paste0(substitute(x)))
  }
plot_depth(dsm.qp)
plot_depth(dsm.qp.xy)
plot_depth(dsm.tw)
plot_depth(dsm.tw.xy)
plot_depth(dsm.nb)
plot_depth(dsm.nb.xy)
```

## "Best" model

Discarding the two quasi-Poisson models due to their poor Q-Q plot, we can also discard the Tweedie models for the same reason -- both look much poorer compared to the negative binomial models. Between the negative binomial models, though, there is not much of a difference.

The bivariate model has a **very** marginally better AIC and REML score, so we pick that but again save all the models for later comparison when it comes to prediction and variance estimation.

```{r save-models}
save(dsm.qp,
     dsm.qp.xy,
     dsm.tw,
     dsm.tw.xy,
     dsm.nb,
     dsm.nb.xy,
     k1,
     k2,
     file="abundance-est-models.RData")
```
